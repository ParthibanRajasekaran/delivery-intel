# ============================================================================
# Delivery Intel â€” Example GitHub Action
# ============================================================================
# Runs delivery-intel on every push to main and every PR.
# Fails the job if the overall score drops below 40 or critical vulns exist.
#
# Copy this file into your repo at:
#   .github/workflows/delivery-intel.yml
#
# Token resolution (in order):
#   1. DELIVERY_INTEL_TOKEN secret  â€” custom PAT (optional)
#   2. Built-in GITHUB_TOKEN        â€” auto-provided by Actions
# ============================================================================

name: Delivery Intelligence

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Weekly report every Monday at 8 AM UTC
    - cron: "0 8 * * 1"

permissions:
  contents: read
  pull-requests: read

jobs:
  analyze:
    name: DORA & Vulnerability Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Run Delivery Intel
        env:
          GITHUB_TOKEN: ${{ secrets.DELIVERY_INTEL_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          npx delivery-intel@latest ${{ github.repository }} \
            --json \
            --output delivery-intel-report.json

      - name: Upload Report Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: delivery-intel-report
          path: delivery-intel-report.json
          retention-days: 90

      - name: Check Score Threshold
        run: |
          SCORE=$(jq '.score' delivery-intel-report.json)
          echo "ðŸ“Š Delivery Intel Score: $SCORE / 100"

          CRITICAL=$(jq '[.vulnerabilities[] | select(.severity == "critical")] | length' delivery-intel-report.json)
          echo "ðŸ”´ Critical vulnerabilities: $CRITICAL"

          if [ "$CRITICAL" -gt 0 ]; then
            echo "::error::$CRITICAL critical vulnerability(ies) found"
            exit 1
          fi

          if [ "$(echo "$SCORE < 40" | bc)" -eq 1 ]; then
            echo "::error::Score $SCORE is below the minimum threshold of 40"
            exit 1
          fi

          echo "âœ… All checks passed"

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('delivery-intel-report.json', 'utf8'));
            const { score, dpiMetrics, vulnerabilities } = report;

            const ratingEmoji = { Elite: 'ðŸŸ¢', High: 'ðŸ”µ', Medium: 'ðŸŸ¡', Low: 'ðŸ”´', 'N/A': 'âšª' };

            const body = `## ðŸ“Š Delivery Intelligence Report

            | Metric | Value | Rating |
            |--------|-------|--------|
            | **Overall Score** | ${score} / 100 | ${score >= 75 ? 'ðŸŸ¢' : score >= 50 ? 'ðŸŸ¡' : 'ðŸ”´'} |
            | Deployment Frequency | ${report.dpiMetrics.deploymentFrequency.deploysPerWeek.toFixed(1)}/week | ${ratingEmoji[report.dpiMetrics.deploymentFrequency.rating]} ${report.dpiMetrics.deploymentFrequency.rating} |
            | Lead Time for Changes | ${report.dpiMetrics.leadTimeForChanges.medianHours?.toFixed(1) ?? 'N/A'}h | ${ratingEmoji[report.dpiMetrics.leadTimeForChanges.rating]} ${report.dpiMetrics.leadTimeForChanges.rating} |
            | Change Failure Rate | ${report.dpiMetrics.changeFailureRate.percentage.toFixed(1)}% | ${ratingEmoji[report.dpiMetrics.changeFailureRate.rating]} ${report.dpiMetrics.changeFailureRate.rating} |
            | Vulnerabilities | ${vulnerabilities.length} found | ${vulnerabilities.length === 0 ? 'ðŸŸ¢' : 'ðŸ”´'} |

            <details><summary>Full JSON Report</summary>

            \`\`\`json
            ${JSON.stringify(report, null, 2).slice(0, 60000)}
            \`\`\`

            </details>

            *Generated by [delivery-intel](https://github.com/ParthibanRajasekaran/delivery-intel)*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
