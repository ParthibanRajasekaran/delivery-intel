# ============================================================================
# Engineering Hygiene Gate
# ============================================================================
# Runs on every PR to main and posts a Hygiene Report as a PR comment.
# Checks: README.md presence, test coverage >80%, stale PRs without review.
# ============================================================================

name: Engineering Hygiene

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: hygiene-${{ github.ref }}
  cancel-in-progress: true

jobs:
  hygiene:
    name: Hygiene Gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci --legacy-peer-deps

      # Run tests with coverage (json-summary reporter produces coverage-summary.json)
      - name: Run tests with coverage
        run: npm run test:coverage -- --coverage.reporter=json-summary || true

      # Build the CLI so we can use the hygiene check module
      - name: Build CLI
        run: npm run build:cli

      # Run the hygiene gate via a lightweight Node script
      - name: Run Hygiene Check
        id: hygiene
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const { runHygieneCheck } = require('./dist/cli/hygieneCheck.js');
            const fs = require('fs');

            // Try to extract coverage from Vitest JSON output
            let coveragePercent;
            try {
              const raw = fs.readFileSync('coverage/coverage-summary.json', 'utf8');
              const summary = JSON.parse(raw);
              coveragePercent = summary?.total?.statements?.pct ?? undefined;
            } catch {
              console.log('⚠️  Could not read coverage summary — skipping coverage check');
            }

            const report = await runHygieneCheck({
              token: process.env.GITHUB_TOKEN,
              repo: context.repo.owner + '/' + context.repo.repo,
              coveragePercent,
              maxReviewWaitHours: 72,
            });

            // Post or update the PR comment
            const marker = '<!-- delivery-intel-hygiene -->';
            const body = marker + '\n\n' + report.markdownSummary;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c => c.body?.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

            // Fail the job if any check failed
            if (report.overallStatus === 'fail') {
              core.setFailed('Engineering Hygiene gate failed — see PR comment for details.');
            }
